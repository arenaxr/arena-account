{% extends "users/header.html" %}

{% block content %}

{% include 'users/includes/messages.html' %}

<!--Profile-->
<div class="container-fluid">
    <div class="row d-flex justify-content-center align-items-center">
        <div class="col-lg-9 col-md-10 shadow rounded bg-white p-5">

            {% if user.is_authenticated %}
            <h1>User Profile</h1>
            <table>
                <tr>
                    <td><b>Username: </b></td>
                    <td>{{ user.get_username }}</td>
                </tr>
                <tr>
                    <td><b>Name: </b></td>
                    <td>{{ user.first_name }} {{ user.last_name }}</td>
                </tr>
                <tr>
                    <td><b>Email: </b></td>
                    <td>{{ user.email }}</td>
                </tr>
                <tr>
                    <td><b>Role: </b></td>
                    <td>
                        {% if user.is_superuser %} Admin
                        {% elif user.is_staff %} Staff
                        {% elif user.is_authenticated %} User
                        {% else %} Anonymous
                        {% endif %}
                    </td>
                </tr>
            </table>
            <br>
            {% if user.is_superuser %}
            <!-- Set or Remove user as Staff -->
            <h5>Admin Functions:</h5>
            <form action="" id="form_admin" method="POST">
                {% csrf_token %}
                <label for="username">Username:</label>
                <input type="text" id="username" pattern="^[a-z\d](?:[a-z\d]|-(?=[a-z\d])){0,38}$">
                <a id="searchlink" href="{{request.scheme}}://{{request.get_host}}/user/admin/auth/user"
                    class="btn btn-primary btn-sm">Search Users</a>
            </form>
            <script type="text/javascript">
                var link = document.getElementById('searchlink');
                var input = document.getElementById('username');
                input.onchange = input.onkeyup = function() {
                    link.search = '?q=' + encodeURIComponent(input.value);
                    document.getElementById("form_admin").action = link.href;
                };
            </script>
            <br>
            {% endif %}
            <!-- List scenes user can edit, and links -->
            <h5>Scene Permissions:</h5>
            {% if scenes %}
            <table class="table table-sm table-hover">
                <thead class="thead-light">
                    <th>Scene Name (view)</th>
                    <th>Public Read</th>
                    <th>Public Write</th>
                    <th>Anonymous Users</th>
                    <th>Video Conference</th>
                    <th>Other Editors</th>
                    <th>Edit Permissions</th>
                </thead>
                {% for scene in scenes %}
                <form action="profile_update_scene" method="POST">
                    {% csrf_token %}
                    <tr>
                        <td><a href="../../{{ scene.name }}"><b>{{ scene.name }}</b></a></td>
                        <!--public subscribe ok-->
                        <td>
                            {% if scene.public_read %}
                            <i class="fas fa-check"></i>
                            {% else %}
                            <i class="fas fa-times"></i>
                            {% endif %}
                        </td>
                        <!--public publish objects ok-->
                        <td>
                            {% if scene.public_write %}
                            <i class="fas fa-check"></i>
                            {% else %}
                            <i class="fas fa-times"></i>
                            {% endif %}
                        </td>
                        <!--anonymous users ok-->
                        <td>
                            {% if scene.anonymous_users %}
                            <i class="fas fa-check"></i>
                            {% else %}
                            <i class="fas fa-times"></i>
                            {% endif %}
                        </td>
                        <!--video conferencing ok-->
                        <td>
                            {% if scene.video_conference %}
                            <i class="fas fa-check"></i>
                            {% else %}
                            <i class="fas fa-times"></i>
                            {% endif %}
                        </td>
                        <!--number of editors-->
                        <td>
                            {{ scene.editors.all|join:", " }}
                        </td>
                        <td><button type="submit" class="btn btn-primary btn-sm" name="edit"
                                value="{{ scene.name }}">Edit</button></td>
                        </td>
                    </tr>
                </form>
                {% endfor %}
            </table>
            {% else %}
            <table class="table table-sm table-hover">
                <tr>
                    <td>No scenes</td>
                </tr>
            </table>
            {% endif %}
            <br>
            <form action="" id="form_user_account" method="POST">
                {% csrf_token %}
                <input type="button" class="btn btn-danger btn-sm" onclick="clickDelete(this);"
                    value="Delete Account and Scenes" />
            </form>
            {% else %}
            <h5>Anonymous users have no profile.</h5>
            {% endif %}

        </div>
    </div>
    <script>
        async function clickDelete() {
            const confirm_text = 'delete {{ user.get_username }} account and scenes'
            const {
                value: text
            } = await Swal.fire({
                title: 'Are you sure you want to delete account {{ user.get_username }} and all {{ user.get_username }}/+ scenes?',
                showCancelButton: true,
                confirmButtonText: `Yes`,
                customClass: {
                    cancelButton: 'order-1 right-gap',
                    confirmButton: 'order-2',
                },
                html: 'To save a scene under another account: CANCEL this dialog, give Editor permissions to another user, the other user can then Clone Scenes to their account.',
                input: 'text',
                inputLabel: `Confirm by typing "${confirm_text}"`,
                inputPlaceholder: 'Type your confirmation here...',
                inputAttributes: {
                    'aria-label': 'Type your confirmation here'
                },
            })
            if (text == confirm_text) {
                // submit delete in form manually
                const form = document.getElementById('form_user_account');
                const input = document.createElement('input');
                input.setAttribute('name', confirm_text);
                form.appendChild(input);
                form.submit();
            }
        }
    </script>
</div>

{% endblock content %}
